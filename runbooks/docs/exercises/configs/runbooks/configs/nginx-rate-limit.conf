# NGINX rate limiting reference (example)
# Goal: reduce abuse / basic L7 DDoS impact without breaking legitimate users.
# Tune limits to your baseline traffic.

# Define a shared memory zone keyed by client IP
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;

# Optional: limit connections per IP
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

server {
    listen 80;
    server_name example.com;

    # Basic connection limit
    limit_conn conn_limit_per_ip 20;

    location / {
        # Burst allows short spikes; nodelay applies limiting immediately
        limit_req zone=req_limit_per_ip burst=20 nodelay;

        # Helpful headers for debugging (optional)
        add_header X-RateLimit-Info "req_limit_per_ip:10r/s burst=20" always;

        proxy_pass http://upstream_app;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Timeouts to protect upstream under stress
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
        proxy_send_timeout 30s;
    }

    # Example: stricter limits for expensive endpoints
    location /login {
        limit_req zone=req_limit_per_ip burst=5 nodelay;
        proxy_pass http://upstream_app;
    }
}
